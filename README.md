# POST SERVICE
Веб-приложения для публикации и чтения постов и комментариев, аналогичное habr/reddit

## Техническое задание
Реализовать систему для публикации и чтения постов и комментариев с использованием Golang, GraphQL, Postgres 
и docker-compose. 

### Система постов:
- Можно просмотреть список постов.
- Можно просмотреть пост и комментарии под ним.
- Пользователь, написавший пост, может запретить оставление комментариев к своему посту.

### Система комментариев к постам:
- Комментарии организованы иерархически, позволяя вложенность без ограничений.
- Длина текста комментария ограничена до, например, 2000 символов.
- Система пагинации для получения списка комментариев.

## Запуск
### Перед запуском приложения убедитесь, что в главной директории проекта есть файл .env. При клонировании репозитория будет файл .env.example как пример. 

### Переменная IN_MEM_STORAGE отвечает за то, где будут располагаться данные приложения (true -> в локальной памяти, false -> в postgres). 

### Локальный запуск приложения (через docker-compose)
1. `git clone github.com/nedokyrill/posts-service`
2. `make docker-up` - запуск приложения. Makefile автоматом подтягивает переменные окружения, и поднимает только нужные
контейнеры. С помощью специального контейнера migrate миграции поднимаются в бд так же автоматически.
3. `make docker-down` - остановка всех контейнеров.

### Локальный запуск приложения
1. `make migrate-up` - если вы подключены к локальной бд.
2. `make run`

### Запуск тестов
1. `make tests` - запуск всех тестов, с выводом покрытия проекта тестами.

### Реализация
1. В данном проекте помимо всего прочего, использовал библиотеку gin для работы с сервером, zap для логирования, для работы с graphql - gqlgen.
2. Реализовал паттерн graceful shutdown для правильного выключения сервера.
3. Во все слои прокинут контекст ctx который приходит в запросе graphql.
4. Для решения проблемы N+1 комментарии для поста и ответы на комментарий подгружаются только в том случае, 
если они запрашиваются. Таким образом вероятность проблемы значительно снижается. (lazy loading)
5. При создании поста можно указать, разрешены ли для него комментарии. А при создании комментария, проверяется, можно
ли к посту оставлять комментарии.
6. Подписки реализовал с помощью Viewer (`internal/service/viewer_service.go`). Наблюдатели это структуры, у которых
есть канал и айдишник. 

## Функционал приложения
Весь API описан в файлах в директории graphql (схема разбита на два файла - post.graphqls и comment.graphqls).

### Тесты
Для всех слоев приложения реализованы unit-тесты. Для создания моков использован gomok (моки для репо и сервис интерфейсов).

## Примеры запросов
### Получение всех постов
```graphql
query GetAllPosts {
  GetAllPosts(page: 1) {
    id
    title
    author
    isCommentsAllowed
    createdAt
  }
}
```

### Получение поста по его айдишнику вместе с комментариями
```graphql
query GetPostWithComments {
  GetPostById(id: "b83a7c44-0ea8-4ff1-8f46-29c03754e7b8") {
    id
    title
    author
    content
    isCommentsAllowed
    createdAt
    comments(page: 1) {
      id
      author
      content
      parentCommentId
      createdAt
      replies {
        id
        author
        content
        createdAt
      }
    }
  }
}
```

### Создание поста
```graphql
mutation CreatePost {
  CreatePost(title: "test", author: "test", content: "test", isCommentAllowed: true) {
    id
    title
    author
    createdAt
  }
}
```

### Добавить комментарий (в данной случае ответ, но можно не указывать parentCommentid)
```graphql
mutation AddComment {
  AddComment(author: "test", content: "test", postId: "b83a7c44-0ea8-4ff1-8f46-29c03754e7b8", 
      parentCommentId: "c6925607-8284-42b6-aae4-62767f5f9307") {
    id
    author
    content
    parentCommentId
    createdAt
  }
}

```

### Подписаться на уведомления о новых комментариях к посту
```graphql
subscription SubOnPost {
  SubOnPost(postId: "b83a7c44-0ea8-4ff1-8f46-29c03754e7b8") {
    id
    author
    content
    postId
    parentCommentId
    createdAt
  }
}
```